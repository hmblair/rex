#compdef rex

_rex_aliases() {
    local config="$HOME/.config/rex"
    [[ -f $config ]] || return
    local -a aliases
    while IFS='=' read -r name _; do
        [[ -n $name && $name != \#* ]] && aliases+=("${name## }")
    done < "$config"
    compadd -a aliases
}

_rex_hosts() {
    _ssh_hosts 2>/dev/null || _hosts
}

_rex_jobs() {
    _message "job ID (YYYYMMDD-HHMMSS)"
}

_rex() {
    local -a options=(
        '(-V --version)'{-V,--version}'[Show version]'
        '-d[Detach: run in background]'
        '(-n --name)'{-n,--name}'[Name for detached job]:name:'
        '-p[Python interpreter]:python path:_files'
        '*-m[Load module (repeatable)]:module:'
        '(-s --slurm)'{-s,--slurm}'[Use SLURM for compute node execution]'
        '--gpu[Use GPU partition]'
        '--cpu[Use CPU partition (override)]'
        '--debug[Enable debug mode (verbose SSH)]'
        '(-h --help)'{-h,--help}'[Show help]'
    )

    local -a slurm_options=(
        '--partition[SLURM partition]:partition:'
        '--gres[GPU resources (e.g., gpu:1)]:gres:'
        '--time[Time limit (e.g., 2:00:00)]:time:'
    )

    local -a job_commands=(
        '--jobs[List all rex jobs on remote]'
        '--status[Check if job is running]:job:_rex_jobs'
        '--log[Show job output]:job:_rex_jobs'
        '--kill[Kill a running job]:job:_rex_jobs'
        '--watch[Wait for job to complete]:job:_rex_jobs'
        '--gpu-info[Show GPU availability and utilization]'
        '--last[Use most recent job]'
        '--json[Output in JSON format]'
        '(-f --follow)'{-f,--follow}'[Follow log output]'
    )

    local -a sync_options=(
        '--sync[Sync project to remote]:path:_files -/'
        '--no-install[Skip pip install after sync]'
        '--build[Create/update venv on remote]'
        '--clean[Delete venv before rebuilding]'
        '--wait[Wait for build to complete]'
    )

    local -a transfer_options=(
        '--push[Upload local file/dir to remote]:local path:_files'
        '--pull[Download remote file/dir to local]:remote path:'
    )

    local -a exec_options=(
        '--exec[Execute shell command on remote]:command:'
        '--exec-login[Execute on login node (bypass SLURM)]:command:'
    )

    local -a connection_options=(
        '--connect[Open persistent SSH connection]'
        '--disconnect[Close persistent SSH connection]'
        '--connection[Show connection status]'
    )

    _arguments -s \
        '1:host:->host' \
        "${options[@]}" \
        "${slurm_options[@]}" \
        "${job_commands[@]}" \
        "${sync_options[@]}" \
        "${transfer_options[@]}" \
        "${exec_options[@]}" \
        "${connection_options[@]}" \
        '*:file:_files -g "*.py"'

    case $state in
        host)
            _alternative \
                'aliases:alias:_rex_aliases' \
                'hosts:host:_rex_hosts'
            ;;
    esac
}

_rex "$@"
